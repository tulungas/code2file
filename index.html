<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Code Editor & Downloader</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <!-- CodeMirror Themes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/eclipse.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/xq-light.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root { --primary-color: #007bff; --primary-hover-color: #0056b3; --primary-active-color: #004085; --container-bg-color: #ffffff; --light-bg-color: #f4f7f9; --dark-text-color: #212529; --medium-text-color: #495057; --border-color: #e0e0e0; --input-focus-border: #86b7fe; --input-focus-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); --box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08); --border-radius: 12px; --editor-default-font-size: 0.95rem; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--light-bg-color); color: var(--dark-text-color); display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 25px 15px; line-height: 1.6; }
        .container { background-color: var(--container-bg-color); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); width: 100%; max-width: 950px; }
        h1 { text-align: center; color: var(--primary-color); margin-bottom: 20px; font-weight: 600; font-size: 2rem; }
        h1 svg { vertical-align: -0.18em; margin-right: 10px; }
        .top-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px; flex-wrap: wrap; }
        .top-controls .form-group { flex-grow: 1; min-width: 200px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--medium-text-color); font-size: 0.9rem; }
        .editor-main-area { margin-bottom: 25px; }
        .editor-toolbar { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; justify-content: flex-start; align-items: center; }
        .editor-toolbar button, .editor-toolbar select { padding: 7px 12px; font-size: 0.85rem; background-color: #f8f9fa; color: var(--dark-text-color); border: 1px solid var(--border-color); border-radius: 5px; cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.1s ease; display: inline-flex; align-items: center; gap: 5px; }
        .editor-toolbar button:hover, .editor-toolbar select:hover { background-color: #e9ecef; border-color: #adb5bd; transform: translateY(-1px); }
        .editor-toolbar button:active, .editor-toolbar select:active { background-color: #dee2e6; transform: translateY(0); }
        .editor-toolbar button i { font-size: 1.05em; }
        .editor-toolbar select { min-width: 120px; }
        .font-size-controls button { min-width: 35px; justify-content: center; }
        .CodeMirror { border: 1px solid var(--border-color); border-radius: var(--border-radius); height: auto; min-height: 350px; font-size: var(--editor-default-font-size); line-height: 1.5; }
        .cm-s-material-darker.CodeMirror { background-color: #263238; }
         .cm-s-eclipse .CodeMirror-gutters, .cm-s-xq-light .CodeMirror-gutters { background-color: #f0f0f0 !important; border-right-color: #ddd !important; }
        .cm-s-eclipse .CodeMirror-linenumber, .cm-s-xq-light .CodeMirror-linenumber { color: #999 !important; }
        .CodeMirror-focused { border-color: var(--input-focus-border); box-shadow: var(--input-focus-shadow); }
        .CodeMirror-gutters { background-color: #2c3b41 !important; border-right: 1px solid #3d4f57 !important; }
        .CodeMirror-linenumber { color: #78909c !important; }
        .stats-bar { margin-top: 12px; margin-bottom: 20px; padding: 8px 10px; background-color: #e9ecef; border-radius: 5px; font-size: 0.8rem; color: var(--medium-text-color); text-align: right; }
        .bottom-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
        input[type="text"], select { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.95rem; color: var(--dark-text-color); background-color: #fff; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
        input[type="text"]:focus, select:focus { border-color: var(--input-focus-border); outline: 0; box-shadow: var(--input-focus-shadow); }
        .top-controls select { padding: 8px 10px; font-size: 0.9rem; }
        button#downloadButton { display: flex; align-items: center; justify-content: center; width: 100%; padding: 12px 18px; background-image: linear-gradient(to right, var(--primary-color) 0%, var(--primary-hover-color) 100%); color: white; border: none; border-radius: 6px; font-size: 1.1rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; text-align: center; box-shadow: 0 4px 10px rgba(0, 123, 255, 0.25); }
        button#downloadButton .icon { margin-right: 8px; width: 1.05em; height: 1.05em; }
        button#downloadButton:hover { background-image: linear-gradient(to right, var(--primary-hover-color) 0%, var(--primary-active-color) 100%); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0, 91, 190, 0.3); }
        #autoSaveStatus { font-size: 0.8rem; color: var(--medium-text-color); margin-left: auto; padding: 0 10px; }
        @media (max-width: 768px) { .container { padding: 20px; } h1 { font-size: 1.8rem; } .CodeMirror { min-height: 300px; } .top-controls, .bottom-controls { grid-template-columns: 1fr; } }
        @media (max-width: 600px) { .container { padding: 15px; } h1 { font-size: 1.6rem; } .CodeMirror { min-height: 250px; } .editor-toolbar { justify-content: space-around; } .editor-toolbar button, .editor-toolbar select { padding: 6px 8px; font-size: 0.8rem; } .editor-toolbar button span { display: none; } .editor-toolbar button i { margin-right: 0; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>
           <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="currentColor" class="bi bi-code-slash" viewBox="0 0 16 16">
                <path d="M10.478 1.647a.5.5 0 1 0-.956-.294l-4 13a.5.5 0 0 0 .956.294l4-13zM4.854 4.146a.5.5 0 0 1 0 .708L1.707 8l3.147 3.146a.5.5 0 0 1-.708.708l-3.5-3.5a.5.5 0 0 1 0-.708l3.5-3.5a.5.5 0 0 1 .708 0zm6.292 0a.5.5 0 0 0 0 .708L14.293 8l-3.147 3.146a.5.5 0 0 0 .708.708l3.5-3.5a.5.5 0 0 0 0-.708l-3.5-3.5a.5.5 0 0 0-.708 0z"/>
            </svg>
            Advanced Code Editor & Downloader
        </h1>

        <div class="top-controls">
            <div class="form-group">
                <label for="fileType">Language / File Type:</label>
                <select id="fileType">
                    <option value=".txt" data-mode="text/plain">.txt (Text File)</option>
                    <option value=".pdf" data-mode="text/plain">.pdf (PDF Document)</option>
                    <option value=".html" data-mode="text/html">.html (HTML File)</option>
                    <option value=".css" data-mode="text/css">.css (CSS File)</option>
                    <option value=".js" data-mode="text/javascript">.js (JavaScript File)</option>
                    <option value=".py" data-mode="text/x-python">.py (Python Script)</option>
                    <option value=".java" data-mode="text/x-java">.java (Java Source)</option>
                    <option value=".c" data-mode="text/x-csrc">.c (C Source)</option>
                    <option value=".cpp" data-mode="text/x-c++src">.cpp (C++ Source)</option>
                    <option value=".cs" data-mode="text/x-csharp">.cs (C# Source)</option>
                    <option value=".rb" data-mode="text/x-ruby">.rb (Ruby Script)</option>
                    <option value=".php" data-mode="application/x-httpd-php">.php (PHP Script)</option>
                    <option value=".sh" data-mode="text/x-sh">.sh (Shell Script)</option>
                    <option value=".bat" data-mode="text/x-bat">.bat (Batch File)</option>
                    <option value=".md" data-mode="text/markdown">.md (Markdown)</option>
                    <option value=".xml" data-mode="application/xml">.xml (XML File)</option>
                    <option value=".json" data-mode="application/json">.json (JSON File)</option>
                    <option value=".sql" data-mode="text/x-sql">.sql (SQL Script)</option>
                    <option value=".svg" data-mode="image/svg+xml">.svg (SVG Image)</option>
                    <option value=".csv" data-mode="text/x-textile">.csv (Comma Separated Values)</option>
                    <option value=".log" data-mode="text/plain">.log (Log File)</option>
                    <option value=".conf" data-mode="text/x-properties">.conf (Config File)</option>
                    <option value=".yaml" data-mode="text/x-yaml">.yaml (YAML File)</option>
                    <option value=".yml" data-mode="text/x-yaml">.yml (YAML File)</option>
                    <option value=".ini" data-mode="text/x-ini">.ini (INI File)</option>
                    <option value="" data-mode="text/plain">(No Extension / Plain)</option>
                </select>
            </div>
            <div class="form-group">
                 <label for="themeSelector">Editor Theme:</label>
                 <select id="themeSelector">
                    <option value="material-darker">Material Darker</option>
                    <option value="dracula">Dracula</option>
                    <option value="monokai">Monokai</option>
                    <option value="eclipse">Eclipse (Light)</option>
                    <option value="xq-light">XQ Light</option>
                </select>
            </div>
        </div>
        <div class="editor-main-area">
            <div class="editor-toolbar">
                <button id="pasteCodeButton" title="Paste (Ctrl+V)"><i class="bi bi-clipboard-plus"></i> <span>Paste</span></button>
                <button id="copyCodeButton" title="Copy (Ctrl+C)"><i class="bi bi-clipboard"></i> <span>Copy</span></button>
                <button id="toggleLineNumbersButton" title="Toggle Line Numbers"><i class="bi bi-list-ol"></i> <span>Lines</span></button>
                <button id="toggleWrapButton" title="Toggle Line Wrapping"><i class="bi bi-text-wrap"></i> <span>Wrap</span></button>
                <div class="font-size-controls" style="display:inline-flex; gap: 5px; margin-left:10px;">
                    <button id="decreaseFontSizeButton" title="Decrease Font Size (Ctrl+-)"><i class="bi bi-zoom-out"></i></button>
                    <button id="increaseFontSizeButton" title="Increase Font Size (Ctrl+=)"><i class="bi bi-zoom-in"></i></button>
                </div>
                <button id="clearEditorButton" title="Clear Editor"><i class="bi bi-trash3"></i> <span>Clear</span></button>
                <span id="autoSaveStatus"></span>
            </div>
            <div id="codeEditorWrapper" style="position: relative;">
                 <div id="codeEditor"></div>
            </div>
            <div class="stats-bar" id="statsBar">Lines: 0 | Words: 0 | Chars: 0</div>
        </div>
        
        <div class="bottom-controls">
            <div class="form-group">
                <label for="fileName">Filename (no extension):</label>
                <input type="text" id="fileName" value="myFile">
            </div>
        </div>

        <button id="downloadButton">
            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" class="bi bi-download icon" viewBox="0 0 16 16">
                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
            </svg>
            <span id="buttonText">Download As .pdf</span>
        </button>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/mode/loadmode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/meta.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/matchbrackets.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closebrackets.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/comment/comment.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/selection/active-line.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/php/php.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/ruby/ruby.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/shell/shell.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/yaml/yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/properties/properties.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/powershell/powershell.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/textile/textile.min.js"></script>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // All your existing element selectors and constants are perfect.
            const fileNameElement = document.getElementById('fileName');
            const fileTypeElement = document.getElementById('fileType');
            const downloadButton = document.getElementById('downloadButton');
            const buttonTextElement = document.getElementById('buttonText');
            const toggleLineNumbersButton = document.getElementById('toggleLineNumbersButton');
            const toggleLineNumbersButtonText = toggleLineNumbersButton.querySelector('span');
            const toggleWrapButton = document.getElementById('toggleWrapButton');
            const toggleWrapButtonText = toggleWrapButton.querySelector('span');
            const clearEditorButton = document.getElementById('clearEditorButton');
            const copyCodeButton = document.getElementById('copyCodeButton');
            const pasteCodeButton = document.getElementById('pasteCodeButton');
            const statsBarElement = document.getElementById('statsBar');
            const increaseFontSizeButton = document.getElementById('increaseFontSizeButton');
            const decreaseFontSizeButton = document.getElementById('decreaseFontSizeButton');
            const themeSelectorElement = document.getElementById('themeSelector');
            const autoSaveStatusElement = document.getElementById('autoSaveStatus');
            const EDITOR_CONTENT_KEY = 'codeMirrorContent_v4';
            const EDITOR_FONT_SIZE_KEY = 'codeMirrorFontSize_v4';
            const EDITOR_THEME_KEY = 'codeMirrorTheme_v4';
            let currentFontSize = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--editor-default-font-size').replace('rem','')) * 16 || 15;
            
            // The entire setup for CodeMirror, its features, and local storage is unchanged.
            // ... (all your existing functions like loadSettings, editor setup, updateFontSize, theme changes, etc. remain here, untouched)
             function loadSettings() {
                const savedFontSize = localStorage.getItem(EDITOR_FONT_SIZE_KEY);
                if (savedFontSize) { currentFontSize = parseFloat(savedFontSize); }
                const savedTheme = localStorage.getItem(EDITOR_THEME_KEY);
                if (savedTheme) { themeSelectorElement.value = savedTheme; }
            }
            loadSettings();
            const editor = CodeMirror(document.getElementById('codeEditor'), {
                value: localStorage.getItem(EDITOR_CONTENT_KEY) || "// Welcome! Paste your code here or use the 'Paste' button.\n// Select the language for syntax highlighting.\n\nfunction helloWorld() {\n  console.log('Hello, Coder!');\n}",
                theme: themeSelectorElement.value, lineNumbers: true, lineWrapping: true, autofocus: true, matchBrackets: true, autoCloseBrackets: true, styleActiveLine: true,
                extraKeys: { "Ctrl-Space": "autocomplete", "Ctrl-/": "toggleComment", "Cmd-/": "toggleComment" }
            });
            editor.getWrapperElement().style.fontSize = currentFontSize + 'px';
            editor.refresh();
            CodeMirror.modeURL = "https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/%N/%N.min.js";
            function updateFontSize(newSize) {
                currentFontSize = Math.max(8, Math.min(30, newSize));
                editor.getWrapperElement().style.fontSize = currentFontSize + 'px';
                editor.refresh();
                localStorage.setItem(EDITOR_FONT_SIZE_KEY, currentFontSize);
            }
            increaseFontSizeButton.addEventListener('click', () => updateFontSize(currentFontSize + 1));
            decreaseFontSizeButton.addEventListener('click', () => updateFontSize(currentFontSize - 1));
            themeSelectorElement.addEventListener('change', (e) => {
                const newTheme = e.target.value;
                editor.setOption("theme", newTheme);
                localStorage.setItem(EDITOR_THEME_KEY, newTheme);
            });
            let autoSaveTimeout;
            editor.on('change', () => {
                clearTimeout(autoSaveTimeout);
                autoSaveStatusElement.textContent = 'Saving...';
                autoSaveTimeout = setTimeout(() => {
                    localStorage.setItem(EDITOR_CONTENT_KEY, editor.getValue());
                    autoSaveStatusElement.textContent = 'Saved ✔';
                    setTimeout(() => autoSaveStatusElement.textContent = '', 2000);
                }, 1500);
                updateEditorStats();
            });
            function updateEditorStats() {
                const content = editor.getValue();
                const lineCount = editor.lineCount();
                const charCount = content.length;
                const wordCount = content ? content.trim().split(/\s+/).filter(Boolean).length : 0;
                statsBarElement.textContent = `Lines: ${lineCount} | Words: ${wordCount} | Chars: ${charCount}`;
            }
            function updateButtonTextAndEditorMode() {
                const selectedOption = fileTypeElement.options[fileTypeElement.selectedIndex];
                const fileExtension = selectedOption.value;
                let editorMode = selectedOption.dataset.mode || 'text/plain';
                if (fileExtension) { buttonTextElement.textContent = `Download As ${fileExtension}`; } 
                else { buttonTextElement.textContent = `Download (No Extension)`; }
                let modeInfo = CodeMirror.findModeByMIME(editorMode) || CodeMirror.findModeByExtension(fileExtension.substring(1));
                if (modeInfo) {
                    editor.setOption('mode', modeInfo.mime);
                    CodeMirror.autoLoadMode(editor, modeInfo.mode);
                } else { editor.setOption('mode', 'text/plain'); }
            }
            fileTypeElement.addEventListener('change', updateButtonTextAndEditorMode);
            function setInitialButtonStates() {
                toggleLineNumbersButtonText.textContent = editor.getOption('lineNumbers') ? 'Hide Lines' : 'Show Lines';
                toggleWrapButtonText.textContent = editor.getOption('lineWrapping') ? 'Disable Wrap' : 'Enable Wrap';
                updateEditorStats();
                themeSelectorElement.dispatchEvent(new Event('change'));
            }
            toggleLineNumbersButton.addEventListener('click', () => {
                const currentNumbers = editor.getOption('lineNumbers');
                editor.setOption('lineNumbers', !currentNumbers);
                toggleLineNumbersButtonText.textContent = !currentNumbers ? 'Hide Lines' : 'Show Lines';
                editor.refresh();
            });
            toggleWrapButton.addEventListener('click', () => {
                const currentWrapping = editor.getOption('lineWrapping');
                editor.setOption('lineWrapping', !currentWrapping);
                toggleWrapButtonText.textContent = !currentWrapping ? 'Disable Wrap' : 'Enable Wrap';
                editor.refresh();
            });
            clearEditorButton.addEventListener('click', () => {
                editor.setValue('');
                localStorage.removeItem(EDITOR_CONTENT_KEY);
                autoSaveStatusElement.textContent = 'Cleared';
                setTimeout(() => autoSaveStatusElement.textContent = '', 1500);
                editor.focus(); updateEditorStats();
            });
            copyCodeButton.addEventListener('click', () => { /* unchanged */
                 const codeToCopy = editor.getValue();
                if (navigator.clipboard && codeToCopy) {
                    navigator.clipboard.writeText(codeToCopy).then(() => {
                        const originalText = copyCodeButton.querySelector('span').textContent; copyCodeButton.querySelector('span').textContent = 'Copied!'; copyCodeButton.disabled = true;
                        setTimeout(() => { copyCodeButton.querySelector('span').textContent = originalText; copyCodeButton.disabled = false; }, 1500);
                    }).catch(err => { console.error('Failed to copy: ', err); alert('Failed to copy code. Check console for errors.'); });
                }
            });
            pasteCodeButton.addEventListener('click', async () => { /* unchanged */
                if (navigator.clipboard && navigator.clipboard.readText) {
                    try { const text = await navigator.clipboard.readText(); if (text) { editor.replaceSelection(text); editor.focus(); } } 
                    catch (err) { console.error('Failed to paste from clipboard:', err); alert('Failed to paste. Please ensure you have granted clipboard permissions, or try Ctrl+V / Cmd+V.'); }
                } else { alert('Clipboard API not available. Please use Ctrl+V / Cmd+V to paste.'); }
            });
            updateButtonTextAndEditorMode();
            setInitialButtonStates();
            if (editor.getValue()) { updateEditorStats(); }
            // --- END OF UNCHANGED SETUP CODE ---


            // --- MODIFIED: Download button logic to handle PDF vs other files ---
            downloadButton.addEventListener('click', () => {
                const textToSave = editor.getValue();
                if (!textToSave.trim()) {
                    alert("Editor is empty. Nothing to download."); return;
                }
                let filename = fileNameElement.value.trim() || "myFile";
                const fileExtension = fileTypeElement.value;
                const fullFilename = filename + fileExtension;
                
                // Check if PDF is the selected format
                if (fileExtension === '.pdf') {
                    // --- PDF Generation Logic (Multi-page capable) ---
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                    
                    const margin = 15;
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const usableWidth = pageWidth - (margin * 2);
                    const pageHeight = doc.internal.pageSize.getHeight();
                    
                    doc.setFont('Courier', 'normal'); // Monospaced font looks like code
                    doc.setFontSize(10); // A good size for code
                    
                    const lines = doc.splitTextToSize(textToSave, usableWidth);
                    
                    let cursorY = margin;
                    lines.forEach(line => {
                        // Check if we need a new page
                        if (cursorY + 6 > pageHeight - margin) { // 6mm is approx line height
                            doc.addPage();
                            cursorY = margin;
                        }
                        doc.text(line, margin, cursorY);
                        cursorY += 6; // Move cursor down for the next line
                    });

                    doc.save(fullFilename);

                } else {
                    // --- ORIGINAL LOGIC: For all other file types (unchanged) ---
                    let mimeType = 'text/plain;charset=utf-8';
                    const selectedOptionForDownload = fileTypeElement.options[fileTypeElement.selectedIndex];
                    const editorMimeForDownload = selectedOptionForDownload.dataset.mode;

                    if(editorMimeForDownload && editorMimeForDownload !== 'text/plain') {
                        mimeType = `${editorMimeForDownload};charset=utf-8`;
                    }
                    if (fileExtension === '.svg' && editorMimeForDownload === 'image/svg+xml') {
                        mimeType = 'image/svg+xml;charset=utf-8';
                    }

                    const blob = new Blob([textToSave], { type: mimeType });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = fullFilename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                }
            });
        });
    </script>
</body>
</html>